<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><chapter lang="ru" id="chapter3_examples">
  <title>Примеры построения отчетов</title>
  <para>Рассмотрим создание следующих отчетов.</para>
  <orderedlist>
    <listitem>
      <para><link linkend="report1_id">Отчет <guilabel>Книги, выпущенные издательством в определенном году</guilabel></link></para>
    </listitem>
    <listitem>
      <para><link linkend="report2_id">Отчет <guilabel>Книги по автору</guilabel></link></para>
    </listitem>
  </orderedlist>
  <section id="report1_id">
    <title>Отчет с шаблоном *.odt</title>
    <para>Данный отчет представляет собой список книг, выпущенных определенным издательством в заданном году.</para>
    <para>Начнем формирование отчета с создания шаблона. Для этого откройте <application>OpenOffice.org Writer</application>. Создайте в файле следующий шаблон отчета, представленный на рисунке.</para>
    <para>Обратите внимание на название таблицы.</para>
    <para>Сохраните шаблон отчета, назвав его <filename>ListOfBooksTemplate.odt</filename>.</para>
    <figure>
      <title>Шаблон отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_bookByPublisherAndYearTemplate.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Далее зайдите в подсистему создания отчетов и нажмите на кнопку <guibutton>Создать</guibutton>.</para>
    <para>В поле <guilabel>Имя отчета</guilabel> введите имя отчета − <userinput>Books by publisher and year</userinput>.</para>
    <figure>
      <title>Окно создания отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_reportEditor_reportParameters.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Далее перейдите на вкладку  <guilabel>Шаблоны</guilabel> и нажмите на кнопку <guibutton>Создать</guibutton>. После этого откроется диалоговое окно, представленное на рисунке.</para>
    <figure>
      <title>Окно редактора шаблона</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_templateEditor.png" contentwidth="80%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>В качестве кода шаблона оставьте значение по умолчанию, в поле <guilabel>Тип вывода</guilabel> выберите значение <userinput>Doc</userinput>. Далее нажмите на кнопку <guibutton>Загрузить</guibutton> и в открывшемся окне укажите путь к созданному ранее шаблону <filename>ListOfBooksTemplate.odt</filename>. Затем задайте имя выходного файла <filename>BooksByPublisherAndYearReport</filename> и нажмите на кнопку <guibutton>OK</guibutton>.</para>
    <para>Далее создадим входные параметры отчета.  Очевидно, входными параметрами будут являться издательство и год издания книги. Для создания параметра перейдите на вкладку <guilabel>Параметры и форматы</guilabel> и нажмите на кнопку <guibutton>Создать</guibutton> на панели <guilabel>Параметры</guilabel>. </para>
    <figure>
      <title>Создание параметра Publisher</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_publisherParameterEditor.png" contentwidth="80%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Заполните поля параметра. В поле <guilabel>Имя параметра</guilabel> введите <userinput>Publisher</userinput>, в качестве <glossterm linkend="glossary_alias_id">алиаса</glossterm> параметра укажите <userinput>publisher</userinput>. Выберите тип параметра <userinput>Объект</userinput> из списка типов. Далее установите флажок <guilabel>Обязательный параметр?</guilabel>. В качестве сущности выберите <userinput>Publisher</userinput> из списка сущностей. В списке экранов выбора сущности найдите экран <userinput>library$Publisher.lookup</userinput>. Далее перейдите на вкладку <guilabel>Локализация</guilabel>.</para>
    <figure>
      <title>Локализация названия параметра</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_publisherParameterLocalization.png" contentwidth="80%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>В поле <guilabel>Строки локализации</guilabel> введите значение <userinput>ru=Издательство</userinput> и нажмите на кнопку <guibutton>ОК.</guibutton></para>
    <para>Далее приступим к созданию полос отчета. Для создания новой полосы выделите корневую полосу отчета <guilabel>Root</guilabel> и нажмите на кнопку <inlinemediaobject>
        <imageobject>
          <imagedata fileref="img/create.png"/>
        </imageobject>
      </inlinemediaobject>.</para>
    <figure>
      <title>Окно создания полос отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_common_reportBandsCreating.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Заполните поля источника данных значениями, приведенными на рисунке.</para>
    <figure>
      <title>Создание полосы header</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_headerBandCreating.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Текст SQL-запроса : </para>
    <programlisting>SELECT publisher.name AS p_name, publication.year AS p_year
FROM library_publisher publisher JOIN library_book_publication publication ON publisher.id=publication.publisher_id
WHERE publisher.id=${publisher} AND publication.year=${year}</programlisting>
    <warning>
      <para>Обратите внимание, что <glossterm linkend="glossary_alias_id">алиасы</glossterm> в запросе называются так же, как в создаваемом шаблоне. В  качестве идентификатора сущности <code>library$Publisher</code> передается входной параметр <code>publisher</code>, заключенный в конструкцию <code>${}</code> − <code>${publisher}</code>, а в качестве заданного года издания передается параметр <code>${year}</code>.</para>
    </warning>
    <tip>
      <para>В SQL-запросе использование алиасов необязательно. В этом случае формат задания атрибутов  в шаблоне будет следующим:</para>
      <para><programlisting>&lt;имя полосы&gt;.&lt;имя атрибута в таблице&gt;</programlisting></para>
      <para>Вид шаблона отчета представлен на рисунке ниже.</para>
      <figure>
        <title>Шаблон отчета без использвоания алиасов</title>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/example_odt_templateWithoutAliases.png"/>
          </imageobject>
        </mediaobject>
      </figure>
      <para>Текст SQL-запроса для полосы отчета header:</para>
      <programlisting>SELECT publisher.name, publication.year
FROM library_publisher publisher JOIN library_book_publication publication ON publisher.id=publication.publisher_id
WHERE publisher.id=${publisher} AND publication.year=${year}</programlisting>
      <para>Если  в SQL-запросе используются алиасы и в качестве СУБД используется PostgreSQL, то необходимо обернуть имена алиасов в двойные кавычки. </para>
    </tip>
    <para>Текст SQL-запроса для получения выбранных пользователем параметров выглядит несколько громоздко. В данном случае лучше использовать более компактный Groovy-скрипт:</para>
    <programlisting>[[&apos;p_name&apos; : (params[&apos;publisher&apos;].name)]]</programlisting>
    <para>После создания полосы отчета <guilabel>header</guilabel> создадим полосу отчета <guilabel>books</guilabel>. Для этого выделите корневую полосу отчета <guilabel>Root</guilabel> и нажмите на кнопку <inlinemediaobject>
        <imageobject>
          <imagedata fileref="img/create.png"/>
        </imageobject>
      </inlinemediaobject>. Далее заполните поля источника данных в соответствии с рисунком.</para>
    <figure>
      <title>Создание полосы books</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_booksBandCreating.png" width="85%" depth="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Текст SQL-скрипта:</para>
    <programlisting>SELECT b.name as name, a.first_name as first_name, a.last_name as last_name
FROM library_book b JOIN library_book_author_link ba ON b.id=ba.book_id 
    JOIN library_author a ON a.id=ba.author_id 
    JOIN library_book_publication publication ON b.id=publication.book_id
JOIN library_publisher publisher ON publication.publisher_id=publisher.id
WHERE publisher.id=${publisher} AND publication.year=${year}</programlisting>
    <para>После создания полос перейдите на вкладку <guilabel>Локализация</guilabel> редактора отчетов и введите в поле <guilabel>Строки локализации </guilabel>следующее:</para>
    <para><userinput>ru=Книги, выпущенные издателем в определенном году</userinput></para>
    <para>После этого нажмите на  кнопку <guibutton>Сохранить и Выполнить</guibutton>, если вы хотите запустить отчет сразу после заполнения из кнопок, или на одну из кнопок <guibutton>ОК и Закрыть</guibutton> или <guibutton>OK</guibutton>. Новый отчет создан и сохранен в базе данных.</para>
    <para>Чтобы запустить сохраненный отчет на выполнение вернитесь на вкладку <guilabel>Список отчетов</guilabel> (<guimenu>Отчеты</guimenu> −&gt; <guimenu>Отчеты</guimenu>). </para>
    <figure>
      <title>Запуск отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_runReport.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Выделите отчет <guilabel>Книги, выпущенные издателем в определенном году</guilabel> в списке отчетов и нажмите на кнопку <guibutton>Выполнить</guibutton>. После этого откроется окно ввода параметров отчета. Данное окно представлено на рисунке.</para>
    <figure>
      <title>Окно ввода параметров отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_runing.png" contentwidth="90%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>В поле <guilabel>Издательство</guilabel> нажмите на кнопку <inlinemediaobject>
        <imageobject>
          <imagedata fileref="img/dots.png"/>
        </imageobject>
      </inlinemediaobject>. В открывшемся окне со списком издательств выберите одно. Задайте необходимый год издания и нажмите на кнопку <guibutton>Печатать отчет</guibutton> в окне ввода параметров отчета.</para>
    <para>Выгруженный отчет представлен на рисунке ниже.</para>
    <figure>
      <title>Выгруженный отчет</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_odt_result.png"/>
        </imageobject>
      </mediaobject>
    </figure>
  </section>
  <section id="report2_id">
    <title>Отчет с шаблоном *.xls</title>
    <para>Данный отчет представляет собой информацию о  книгах, написанных определенным автором, который задается параметрами отчета.</para>
    <para>Начнем формирование отчета с создания шаблона. Для этого откройте <application>OpenOffice.org Calc</application>. Создайте в файле  шаблон отчета, представленный на рисунке.</para>
    <figure>
      <title>Создание шаблона отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/booksByAuthorTemplate.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Задайте именованные регионы согласно изображениям, представленным ниже.</para>
    <figure>
      <title>Именованный регион header</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/headerRegion.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <figure>
      <title>Именованный регион book</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/bookTemplate.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <figure>
      <title>Именованный регион publisher</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/publisherTemplate.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <figure>
      <title>Именованный регион publication</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/publicationTemplate.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Сохраните шаблон отчета, назвав его <filename>BooksByAuthorTemplate.xls</filename>.</para>
    <para>Далее зайдите в подсистему создания отчетов и нажмите на кнопку <guibutton>Создать</guibutton>.</para>
    <figure>
      <title>Окно создания отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_reportEditor.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>В поле <guilabel>Имя</guilabel> введите имя отчета − Books by author. На вкладке <guilabel>Локализация</guilabel> задайте локализованное имя отчета.</para>
    <para>Далее создадим входные параметры отчета. Для этого перейдите на вкладку <guilabel>Параметры и форматы</guilabel> и нажмите на кнопку <guibutton>Создать</guibutton> на панели <guilabel>Параметры</guilabel>. После этого откроется  окно редактора параметров. Заполните поля редактора значениями, представленными на рисунке.</para>
    <figure>
      <title>Окно редактора параметров</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_parametersEditor.png" contentwidth="80%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Перейдите на вкладку <guilabel>Локализация</guilabel> и в поле <guilabel>Строки локализации</guilabel> введите значение <userinput>ru=Автор</userinput> и нажмите на кнопку <guibutton>ОК</guibutton>.</para>
    <para>Перейдите на вкладку <guilabel>Шаблоны</guilabel> и нажмите на кнопку <guibutton>Создать</guibutton>. После этого откроется окно редактора шаблона. </para>
    <figure>
      <title>Окно редактора шаблона </title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/templateEditor.png" contentwidth="80%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>В качестве кода шаблона оставьте значение по умолчанию, в поле <guilabel>Тип вывода</guilabel> выберите значение <userinput>Xls</userinput>. Далее нажмите на кнопку <guibutton>Загрузить</guibutton> и в открывшемся окне укажите путь к созданному ранее шаблону <filename>BooksByAuthorTemplate.xls</filename>.</para>
    <para>Далее приступим к созданию полос отчета. Вернитесь на вкладку <guilabel>Параметры отчета</guilabel>. Для создания новой полосы выделите корневую полосу отчета <guilabel>Root</guilabel> и нажмите на кнопку <inlinemediaobject>
        <imageobject>
          <imagedata fileref="img/create.png"/>
        </imageobject>
      </inlinemediaobject>.</para>
    <figure>
      <title>Окно создания полос отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_common_reportBandsCreating.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Выделите созданную полосу отчета и заполните поля на панели <guilabel>Свойства полосы</guilabel> значениями, приведенными на рисунке.</para>
    <figure>
      <title>Создание полосы header</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_headerBandCreating.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Текст Groovy-скрипта:</para>
    <programlisting>[[&apos;authorName&apos; : (params[&apos;author&apos;].firstName + &apos; &apos; + params[&apos;author&apos;].lastName)]]</programlisting>
    <warning>
      <para>Обратите внимание, что <glossterm linkend="glossary_alias_id">алиасы</glossterm> в запросе называются также, как в созданном шаблоне, а для фильтрации значений передается входной параметр отчета <code>author</code>.</para>
    </warning>
    <para>Далее создайте полосу <guilabel>book</guilabel>. Ее параметры приведены на рисунке.  </para>
    <figure>
      <title>Создание полосы book</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_bookBandCreating.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Текст SQL-скрипта:</para>
    <programlisting>select p.name as publisher, bp.year, p.id as publisher_id
from library_book_publication bp
join library_publisher p on p.id = bp.publisher_id
where bp.book_id = ${book.book_id}</programlisting>
    <para>Также нам потребуется создать полосы <guilabel>publisher</guilabel> и <guilabel>publication</guilabel>. Их параметры приведены на рисунках.</para>
    <figure>
      <title>Создание полосы publisher</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_publisherBandCreating.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Текст SQL-скрипта:</para>
    <programlisting>select p.name as publisher, bp.year, p.id as publisher_id
from library_book_publication bp
join library_publisher p on p.id = bp.publisher_id
where bp.book_id = ${book.book_id}</programlisting>
    <figure>
      <title>Создание полосы publication</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_publicationBandCreating.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <programlisting>select ld.name as department, count(bi.id) as amount
from library_book_instance bi
join library_book_publication bp on bp.id = bi.book_publication_id
join library_library_department ld on ld.id = bi.library_department_id
where bp.publisher_id = ${publisher.publisher_id} and bp.book_id = ${book.book_id}
group by ld.name</programlisting>
    <para>После создания полос перейдите на вкладку <guilabel>Локализация</guilabel> редактора отчетов и введите в поле <guilabel>Строки локализации </guilabel>следующее:</para>
    <para><userinput>ru=Книги по автору</userinput></para>
    <para>После этого сохраните отчет, нажав на одну из кнопок <guibutton>ОК и Закрыть</guibutton>, <guibutton>ОК</guibutton>, <guibutton>Сохранить и Выполнить</guibutton>. В последнем случае отчет будет запущен сразу после сохранения. Новый отчет создан и сохранен в базе данных.</para>
    <para>Чтобы запустить отчет на выполнение вернитесь на вкладку <guilabel>Список отчетов</guilabel> (<guimenu>Отчеты</guimenu> −&gt; <guimenu>Отчеты</guimenu>). </para>
    <figure>
      <title>Выполнение отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_runReport.png" width="85%"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Выделите     отчет   <guilabel>Книги по автору</guilabel>  в  списке                     и  нажмите на кнопку    <guibutton>Выполнить</guibutton>. После этого откроется окно ввода параметров отчета. Данное окно представлено на рисунке.</para>
    <figure>
      <title>Окно ввода параметров отчета</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_Runing.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Выберите автора с помощью кнопки <inlinemediaobject>
        <imageobject>
          <imagedata fileref="img/lookup.png"/>
        </imageobject>
      </inlinemediaobject>. </para>
    <para>После этого нажмите на кнопку <guibutton>Печатать отчет</guibutton> в окне ввода параметров отчета и сохраните отчет. </para>
    <para>Выгруженный отчет представлен на рисунке ниже.</para>
    <figure>
      <title>Выгруженный отчет</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/example_xls_result.png"/>
        </imageobject>
      </mediaobject>
    </figure>
  </section>
</chapter>
